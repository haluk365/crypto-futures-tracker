<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binance Futures Takip√ßi</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font:14px 'Segoe UI',sans-serif;background:linear-gradient(135deg,#1e3c72,#2a5298);min-height:100vh;padding:2rem;color:white}
        .container{max-width:1200px;margin:0 auto}
        .header{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:20px;padding:2rem;margin-bottom:2rem;text-align:center}
        .empty-box{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:15px;padding:1.5rem;margin-bottom:2rem;min-height:450px}
        h1{margin-bottom:1.5rem;font-size:2.5rem;background:linear-gradient(45deg,#ffd700,#ffed4e);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .add-coin{display:flex;gap:10px;max-width:400px;margin:0 auto}
        input{flex:1;padding:12px;border:none;border-radius:10px;background:rgba(255,255,255,0.2);color:white;font-size:16px}
        input::placeholder{color:rgba(255,255,255,0.7)}
        input:focus{outline:none;background:rgba(255,255,255,0.3)}
        button{padding:12px 24px;border:none;border-radius:10px;background:linear-gradient(45deg,#ff6b6b,#ee5a24);color:white;cursor:pointer;font-weight:bold}
        button:hover{transform:translateY(-2px)}
        .table-container{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:15px;padding:1.5rem;overflow-x:auto}
        table{width:100%;border-collapse:collapse}
        th{background:rgba(255,255,255,0.1);padding:1rem;text-align:left;color:#ffd700;border-bottom:2px solid rgba(255,255,255,0.2);font-weight:bold}
        td{padding:1rem;border-bottom:1px solid rgba(255,255,255,0.1)}
        tr:hover{background:rgba(255,255,255,0.05)}
        .coin-name{font-weight:bold;color:#ffd700}
        .status{padding:4px 8px;border-radius:6px;font-size:11px;font-weight:bold;text-align:center;min-width:60px;display:inline-block}
        .status.connected{background:rgba(0,255,136,0.2);color:#00ff88}
        .status.disconnected{background:rgba(255,71,87,0.2);color:#ff4757}
        .status.connecting{background:rgba(255,215,0,0.2);color:#ffd700}
        .change-positive{color:#00ff88}
        .change-negative{color:#ff4757}
        .remove-btn{background:linear-gradient(45deg,#ff4757,#c44569);padding:6px 12px;font-size:11px;border:none;border-radius:6px;color:white;cursor:pointer}
        .numeric-cell{text-align:right}
        .no-coins{text-align:center;padding:3rem;opacity:0.7;font-size:1.2rem}
        .sortable{cursor:pointer;user-select:none;position:relative}
        .sortable:hover{background:rgba(255,255,255,0.2)}
        .sortable::after{content:'‚ÜïÔ∏è';position:absolute;right:5px;opacity:0.5}
        .sortable.asc::after{content:'‚Üë';opacity:1;color:#00ff88}
        .sortable.desc::after{content:'‚Üì';opacity:1;color:#ff4757}
        @media (max-width:768px){body{padding:1rem}h1{font-size:2rem}.add-coin{flex-direction:column}}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Binance Futures Takip√ßi</h1>
            <div style="margin-bottom: 1rem; opacity: 0.7; font-size: 12px;">Versiyon 2.1</div>
            <div class="add-coin">
                <input type="text" id="inp" placeholder="Coin adƒ± (√∂rn: BTC)">
                <button onclick="addCoin()">Ekle</button>
            </div>
        </div>
        <div class="empty-box" id="chart-box">
            <div id="tradingview-widget" style="height: 400px;">
                <div style="text-align: center; padding: 150px 0; opacity: 0.7;">
                    üìà Grafik g√∂rmek i√ßin bir coin se√ßin
                </div>
            </div>
        </div>
        <div class="table-container" id="cont">
            <div class="no-coins">Takip etmek istediƒüiniz coinleri yukarƒ±dan ekleyin</div>
        </div>
    </div>

    <script>
        let c = {};
        let s = {col: null, dir: 'asc'};
        let rsiCache = new Map();
        let inputInitialized = false;
        
        const $ = i => document.getElementById(i);
        
        // Format functions
        const fp = p => {
            const n = +p;
            return '$' + (n >= 1 ? n.toFixed(2) : n >= 0.01 ? n.toFixed(4) : n.toFixed(8));
        };
        const fn = n => n >= 1e6 ? (n/1e6).toFixed(2) + 'M' : n >= 1000 ? (n/1000).toFixed(2) + 'K' : (+n).toFixed(2);
        const ff = r => r ? ((+r * 100).toFixed(4) >= 0 ? '+' : '') + (+r * 100).toFixed(4) + '%' : '-';
        
        // RSI calculation
        const calculateRSI = (closes, period = 14) => {
            if (closes.length < period + 1) return null;
            
            let gains = 0;
            let losses = 0;
            
            for (let i = 1; i <= period; i++) {
                const change = closes[i] - closes[i - 1];
                if (change >= 0) {
                    gains += change;
                } else {
                    losses -= change;
                }
            }
            
            let avgGain = gains / period;
            let avgLoss = losses / period;
            
            for (let i = period + 1; i < closes.length; i++) {
                const change = closes[i] - closes[i - 1];
                
                if (change >= 0) {
                    avgGain = (avgGain * (period - 1) + change) / period;
                    avgLoss = (avgLoss * (period - 1)) / period;
                } else {
                    avgGain = (avgGain * (period - 1)) / period;
                    avgLoss = (avgLoss * (period - 1) - change) / period;
                }
            }
            
            if (avgLoss === 0) return 100;
            const rs = avgGain / avgLoss;
            return 100 - (100 / (1 + rs));
        };
        
        // RSI data fetch
        const getRSI = async (symbol) => {
            const now = Date.now();
            
            if (rsiCache.has(symbol)) {
                const cached = rsiCache.get(symbol);
                if (now - cached.timestamp < 300000) {
                    return cached.value;
                }
            }
            
            try {
                const response = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=15m&limit=16`);
                const klines = await response.json();
                
                if (!klines || klines.length < 15) return null;
                
                const closes = klines.map(kline => parseFloat(kline[4]));
                const rsi = calculateRSI(closes, 14);
                
                if (rsi !== null) {
                    rsiCache.set(symbol, {value: rsi, timestamp: now});
                    return rsi;
                }
            } catch (error) {
                console.error(`RSI error for ${symbol}:`, error);
            }
            
            return null;
        };
        
        // Update RSI display
        const updateRSI = async (symbol) => {
            const rsi = await getRSI(symbol);
            const rsiElement = $(`rsi${symbol}`);
            
            if (rsiElement) {
                if (rsi !== null) {
                    rsiElement.textContent = rsi.toFixed(1);
                    rsiElement.style.fontWeight = 'bold';
                    
                    if (rsi > 70) {
                        rsiElement.style.color = '#ff6b6b';
                    } else if (rsi < 30) {
                        rsiElement.style.color = '#51cf66';
                    } else {
                        rsiElement.style.color = '#ffffff';
                    }
                } else {
                    rsiElement.textContent = 'Err';
                    rsiElement.style.color = '#ff4757';
                }
            }
        };
        
        // API functions
        const gf = async s => {
            try {
                const r = await fetch(`https://fapi.binance.com/fapi/v1/premiumIndex?symbol=${s}`);
                return (await r.json()).lastFundingRate;
            } catch {
                return null;
            }
        };
        
        // Storage functions
        const sv = () => {
            try {
                localStorage.setItem('c', JSON.stringify(Object.keys(c)));
            } catch (error) {
                console.error('Save error:', error);
            }
        };
        
        const ld = () => {
            try {
                const d = localStorage.getItem('c');
                if (d) {
                    JSON.parse(d).forEach(s => c[s] = {w: null, l: 0});
                    return Object.keys(c).length > 0;
                }
            } catch (error) {
                console.error('Load error:', error);
            }
            return false;
        };
        
        // UI functions
        const st = (s, m, t) => {
            const e = $(`s${s}`);
            if (e) {
                e.textContent = m;
                e.className = `status ${t}`;
            }
        };
        
        const up = () => {
            const ct = $('cont');
            if (!Object.keys(c).length) {
                ct.innerHTML = '<div class="no-coins">Takip etmek istediƒüiniz coinleri yukarƒ±dan ekleyin</div>';
            } else {
                if (!$('tb')) {
                    ct.innerHTML = `<table><thead><tr><th class="sortable" onclick="sortBy('coin')">Sembol</th><th>Durum</th><th class="sortable" onclick="sortBy('price')">Fiyat</th><th class="sortable" onclick="sortBy('change')">24s %</th><th class="sortable" onclick="sortBy('funding')">Fund</th><th class="sortable" onclick="sortBy('rsi')">RSI</th><th class="sortable" onclick="sortBy('high')">24s Y√ºksek</th><th class="sortable" onclick="sortBy('low')">24s D√º≈ü√ºk</th><th class="sortable" onclick="sortBy('vol')">Hacim</th><th>ƒ∞≈ülem</th></tr></thead><tbody id="tb"></tbody></table>`;
                }
                const tb = $('tb');
                Object.keys(c).forEach(s => {
                    if (!$(`r${s}`)) {
                        tb.innerHTML += `<tr id="r${s}">
                            <td><div class="coin-name" onclick="loadChart('${s}')" style="cursor:pointer;text-decoration:underline;color:#ffd700;" title="Grafiƒüi g√∂rmek i√ßin tƒ±klayƒ±n">${s}</div></td>
                            <td><span class="status connecting" id="s${s}">Baƒülanƒ±yor...</span></td>
                            <td class="numeric-cell"><div id="p${s}">$0.00</div></td>
                            <td class="numeric-cell" id="h${s}">-</td>
                            <td class="numeric-cell" id="f${s}">-</td>
                            <td class="numeric-cell" id="rsi${s}">-</td>
                            <td class="numeric-cell" id="i${s}">-</td>
                            <td class="numeric-cell" id="o${s}">-</td>
                            <td class="numeric-cell" id="v${s}">-</td>
                            <td><button class="remove-btn" onclick="removeCoin('${s}')">Kaldƒ±r</button></td>
                        </tr>`;
                    }
                });
            }
        };
        
        // WebSocket connection
        const cn = s => {
            try {
                const w = new WebSocket(`wss://fstream.binance.com/ws/${s.toLowerCase()}@ticker`);
                c[s].w = w;
                
                // Get funding rate
                gf(s).then(r => {
                    const e = $(`f${s}`);
                    if (e) {
                        e.textContent = ff(r);
                        e.className = `numeric-cell ${(+r || 0) >= 0 ? 'change-positive' : 'change-negative'}`;
                    }
                });
                
                // Get RSI
                updateRSI(s);
                
                // RSI update interval (5 minutes)
                setInterval(() => {
                    if (c[s]) updateRSI(s);
                }, 300000);
                
                w.onopen = () => st(s, 'Baƒülƒ±', 'connected');
                w.onerror = () => st(s, 'Hata', 'disconnected');
                w.onclose = () => st(s, 'Kesildi', 'disconnected');
                
                w.onmessage = e => {
                    try {
                        const d = JSON.parse(e.data);
                        const pe = $(`p${s}`);
                        const he = $(`h${s}`);
                        const ie = $(`i${s}`);
                        const oe = $(`o${s}`);
                        const ve = $(`v${s}`);
                        
                        if (pe) pe.textContent = fp(d.c);
                        if (he) {
                            const ch = +d.P;
                            he.textContent = `${ch >= 0 ? '+' : ''}${ch.toFixed(2)}%`;
                            he.className = `numeric-cell ${ch >= 0 ? 'change-positive' : 'change-negative'}`;
                        }
                        if (ie) ie.textContent = fp(d.h);
                        if (oe) oe.textContent = fp(d.l);
                        if (ve) ve.textContent = fn(d.v);
                        
                        c[s].l = +d.c;
                    } catch (err) {
                        console.error('Parse error:', err);
                    }
                };
                
            } catch (error) {
                console.error('WebSocket error:', error);
            }
        };
        
        // Chart loading
        function loadChart(s) {
            const w = $('tradingview-widget');
            if (!w) return;
            
            w.innerHTML = `<div style="text-align:center;padding:50px 0;opacity:0.7;">üìà ${s} grafiƒüi y√ºkleniyor...</div>`;
            
            setTimeout(() => {
                const script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
                script.async = true;
                script.innerHTML = JSON.stringify({
                    "autosize": true,
                    "symbol": `BINANCE:${s}`,
                    "interval": "15",
                    "timezone": "Etc/UTC",
                    "theme": "dark",
                    "style": "1",
                    "locale": "tr",
                    "enable_publishing": false,
                    "withdateranges": true,
                    "range": "1D",
                    "hide_side_toolbar": false,
                    "allow_symbol_change": false,
                    "save_image": false,
                    "calendar": false,
                    "support_host": "https://www.tradingview.com"
                });
                
                w.innerHTML = `<div class="tradingview-widget-container" style="height:100%;width:100%;"><div class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%;"></div></div>`;
                w.querySelector('.tradingview-widget-container__widget').appendChild(script);
            }, 300);
        }
        
        // Main functions
        function addCoin() {
            const inp = $('inp');
            if (!inp) return;
            
            let symbol = inp.value.trim().toUpperCase();
            if (!symbol) return alert('L√ºtfen bir coin adƒ± girin!');
            if (!symbol.endsWith('USDT')) symbol += 'USDT';
            if (c[symbol]) return alert(`${symbol} zaten takip ediliyor!`);
            if (Object.keys(c).length >= 20) return alert('Maksimum 20 coin takip edebilirsiniz!');
            
            c[symbol] = {w: null, l: 0};
            up();
            cn(symbol);
            sv();
            inp.value = '';
            if (Object.keys(c).length === 1) loadChart(symbol);
        }
        
        function removeCoin(s) {
            if (c[s]) {
                c[s].w?.close();
                delete c[s];
                $(`r${s}`).remove();
                sv();
                if (!Object.keys(c).length) up();
            }
        }
        
        function sortBy(col) {
            const tb = $('tb');
            if (!tb) return;
            
            s.dir = s.col === col ? (s.dir === 'asc' ? 'desc' : 'asc') : 'asc';
            s.col = col;
            
            document.querySelectorAll('.sortable').forEach(th => th.classList.remove('asc', 'desc'));
            document.querySelectorAll('.sortable').forEach(th => {
                if (th.getAttribute('onclick')?.includes(`'${col}'`)) th.classList.add(s.dir);
            });
            
            const rs = Array.from(tb.children);
            const ci = {price: 2, change: 3, funding: 4, rsi: 5, high: 6, low: 7, vol: 8}[col];
            
            rs.sort((a, b) => {
                if (col === 'coin') {
                    const r = a.cells[0].textContent.trim().localeCompare(b.cells[0].textContent.trim());
                    return s.dir === 'asc' ? r : -r;
                }
                let vA = +(a.cells[ci].textContent.replace(/[\$,+%]/g, '') || 0);
                let vB = +(b.cells[ci].textContent.replace(/[\$,+%]/g, '') || 0);
                if (col === 'vol') {
                    const tA = a.cells[ci].textContent;
                    const tB = b.cells[ci].textContent;
                    if (tA.includes('M')) vA *= 1e6;
                    else if (tA.includes('K')) vA *= 1000;
                    if (tB.includes('M')) vB *= 1e6;
                    else if (tB.includes('K')) vB *= 1000;
                }
                return s.dir === 'asc' ? vA - vB : vB - vA;
            });
            
            tb.innerHTML = '';
            rs.forEach(row => tb.appendChild(row));
        }
        
        // Input initialization
        function initInput() {
            const inp = $('inp');
            if (!inp || inputInitialized) return;
            
            inp.addEventListener('keypress', e => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addCoin();
                }
            });
            
            inp.focus();
            inputInitialized = true;
        }
        
        // Initialize app
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initInput();
                if (ld()) {
                    up();
                    Object.keys(c).forEach(cn);
                }
            });
        } else {
            initInput();
            if (ld()) {
                up();
                Object.keys(c).forEach(cn);
            }
        }
        
        window.onbeforeunload = () => {
            Object.values(c).forEach(coin => coin.w?.close());
        };
        
        // Global functions
        window.loadChart = loadChart;
    </script>
</body>
</html>
