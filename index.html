<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binance Futures Takip√ßi</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font:14px 'Segoe UI',sans-serif;background:linear-gradient(135deg,#1e3c72,#2a5298);min-height:100vh;padding:2rem;color:white}
        .container{max-width:1200px;margin:0 auto}
        .header{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:20px;padding:2rem;margin-bottom:2rem;text-align:center}
        .empty-box{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:15px;padding:1.5rem;margin-bottom:2rem;min-height:450px}
        h1{margin-bottom:1.5rem;font-size:2.5rem;background:linear-gradient(45deg,#ffd700,#ffed4e);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .add-coin{display:flex;gap:10px;max-width:400px;margin:0 auto}
        input{flex:1;padding:12px;border:none;border-radius:10px;background:rgba(255,255,255,0.2);color:white;font-size:16px}
        input::placeholder{color:rgba(255,255,255,0.7)}
        input:focus{outline:none;background:rgba(255,255,255,0.3)}
        button{padding:12px 24px;border:none;border-radius:10px;background:linear-gradient(45deg,#ff6b6b,#ee5a24);color:white;cursor:pointer;font-weight:bold}
        button:hover{transform:translateY(-2px)}
        .table-container{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:15px;padding:1.5rem;overflow-x:auto}
        table{width:100%;border-collapse:collapse}
        th{background:rgba(255,255,255,0.1);padding:1rem;text-align:left;color:#ffd700;border-bottom:2px solid rgba(255,255,255,0.2);font-weight:bold}
        td{padding:1rem;border-bottom:1px solid rgba(255,255,255,0.1)}
        tr:hover{background:rgba(255,255,255,0.05)}
        .coin-name{font-weight:bold;color:#ffd700}
        .status{padding:4px 8px;border-radius:6px;font-size:11px;font-weight:bold;text-align:center;min-width:60px;display:inline-block}
        .status.connected{background:rgba(0,255,136,0.2);color:#00ff88}
        .status.disconnected{background:rgba(255,71,87,0.2);color:#ff4757}
        .status.connecting{background:rgba(255,215,0,0.2);color:#ffd700}
        .change-positive{color:#00ff88}
        .change-negative{color:#ff4757}
        .remove-btn{background:linear-gradient(45deg,#ff4757,#c44569);padding:6px 12px;font-size:11px;border:none;border-radius:6px;color:white;cursor:pointer}
        .numeric-cell{text-align:right}
        .no-coins{text-align:center;padding:3rem;opacity:0.7;font-size:1.2rem}
        .sortable{cursor:pointer;user-select:none;position:relative}
        .sortable:hover{background:rgba(255,255,255,0.2)}
        .sortable::after{content:'‚ÜïÔ∏è';position:absolute;right:5px;opacity:0.5}
        .sortable.asc::after{content:'‚Üë';opacity:1;color:#00ff88}
        .sortable.desc::after{content:'‚Üì';opacity:1;color:#ff4757}
        @media (max-width:768px){body{padding:1rem}h1{font-size:2rem}.add-coin{flex-direction:column}}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Binance Futures Takip√ßi</h1>
            <div style="margin-bottom: 1rem; opacity: 0.7; font-size: 12px;">Versiyon 1.8</div>
            <div class="add-coin">
                <input type="text" id="inp" placeholder="Coin adƒ± (√∂rn: BTC)">
                <button onclick="addCoin()">Ekle</button>
            </div>
        </div>
        <div class="empty-box" id="chart-box">
            <div id="tradingview-widget" style="height: 400px;">
                <div style="text-align: center; padding: 150px 0; opacity: 0.7;">
                    üìà Grafik g√∂rmek i√ßin bir coin se√ßin
                </div>
            </div>
        </div>
        <div class="table-container" id="cont">
            <div class="no-coins">Takip etmek istediƒüiniz coinleri yukarƒ±dan ekleyin</div>
        </div>
    </div>

    <script>
        let c = {};
        let s = {col: null, dir: 'asc'};
        
        const $ = i => document.getElementById(i);
        const fp = p => {
            const n = +p;
            return '$' + (n >= 1 ? n.toFixed(2) : n >= 0.01 ? n.toFixed(4) : n.toFixed(8));
        };
        const fn = n => n >= 1e6 ? (n/1e6).toFixed(2) + 'M' : n >= 1000 ? (n/1000).toFixed(2) + 'K' : (+n).toFixed(2);
        const ff = r => r ? ((+r * 100).toFixed(4) >= 0 ? '+' : '') + (+r * 100).toFixed(4) + '%' : '-';
        
        const gf = async s => {
            try {
                const r = await fetch(`https://fapi.binance.com/fapi/v1/premiumIndex?symbol=${s}`);
                return (await r.json()).lastFundingRate;
            } catch {
                return null;
            }
        };
        
        const sv = () => {
            try {
                localStorage.setItem('c', JSON.stringify(Object.keys(c)));
                console.log('Veriler localStorage\'a kaydedildi');
            } catch (error) {
                console.error('localStorage kaydetme hatasƒ±:', error);
                alert('Veriler kaydedilemedi. Tarayƒ±cƒ± depolama alanƒ± dolu olabilir.');
            }
        };
        
        const ld = () => {
            try {
                const d = localStorage.getItem('c');
                if (d) {
                    const coins = JSON.parse(d);
                    coins.forEach(s => c[s] = {w: null, l: 0});
                    console.log(`${coins.length} coin localStorage\'dan y√ºklendi`);
                    return coins.length > 0;
                }
            } catch (error) {
                console.error('localStorage okuma hatasƒ±:', error);
                // localStorage bozuksa temizle
                try {
                    localStorage.removeItem('c');
                } catch (e) {
                    console.error('localStorage temizleme hatasƒ±:', e);
                }
            }
            return false;
        };
        
        const st = (s, m, t) => {
            const e = $(`s${s}`);
            if (e) {
                e.textContent = m;
                e.className = `status ${t}`;
            }
        };
        
        const up = () => {
            const ct = $('cont');
            if (!Object.keys(c).length) {
                ct.innerHTML = '<div class="no-coins">Takip etmek istediƒüiniz coinleri yukarƒ±dan ekleyin</div>';
            } else {
                if (!$('tb')) {
                    ct.innerHTML = `<table><thead><tr><th class="sortable" onclick="sortBy('coin')">Sembol</th><th>Durum</th><th class="sortable" onclick="sortBy('price')">Fiyat</th><th class="sortable" onclick="sortBy('change')">24s %</th><th class="sortable" onclick="sortBy('funding')">Fund</th><th class="sortable" onclick="sortBy('high')">24s Y√ºksek</th><th class="sortable" onclick="sortBy('low')">24s D√º≈ü√ºk</th><th class="sortable" onclick="sortBy('vol')">Hacim</th><th>ƒ∞≈ülem</th></tr></thead><tbody id="tb"></tbody></table>`;
                }
                const tb = $('tb');
                Object.keys(c).forEach(s => {
                    if (!$(`r${s}`)) {
                        tb.innerHTML += `<tr id="r${s}">
                            <td>
                                <div class="coin-name" onclick="loadChart('${s}')" style="cursor:pointer;text-decoration:underline;color:#ffd700;" title="Grafiƒüi g√∂rmek i√ßin tƒ±klayƒ±n">
                                    ${s}
                                </div>
                            </td>
                            <td><span class="status connecting" id="s${s}">Baƒülanƒ±yor...</span></td>
                            <td class="numeric-cell"><div id="p${s}">$0.00</div></td>
                            <td class="numeric-cell" id="h${s}">-</td>
                            <td class="numeric-cell" id="f${s}">-</td>
                            <td class="numeric-cell" id="i${s}">-</td>
                            <td class="numeric-cell" id="o${s}">-</td>
                            <td class="numeric-cell" id="v${s}">-</td>
                            <td><button class="remove-btn" onclick="removeCoin('${s}')">Kaldƒ±r</button></td>
                        </tr>`;
                    }
                });
            }
        };
        
        const cn = s => {
            try {
                const w = new WebSocket(`wss://fstream.binance.com/ws/${s.toLowerCase()}@ticker`);
                c[s].w = w;
                
                // Funding rate al (hata yakalama ile)
                gf(s).then(r => {
                    const e = $(`f${s}`);
                    if (e) {
                        e.textContent = ff(r);
                        e.className = `numeric-cell ${(+r || 0) >= 0 ? 'change-positive' : 'change-negative'}`;
                    }
                }).catch(err => {
                    console.error(`Funding rate hatasƒ± (${s}):`, err);
                    const e = $(`f${s}`);
                    if (e) e.textContent = 'Hata';
                });
                
                w.onopen = () => {
                    console.log(`WebSocket a√ßƒ±ldƒ±: ${s}`);
                    st(s, 'Baƒülƒ±', 'connected');
                };
                
                w.onerror = (error) => {
                    console.error(`WebSocket hatasƒ± (${s}):`, error);
                    st(s, 'Hata', 'disconnected');
                };
                
                w.onclose = (event) => {
                    console.log(`WebSocket kapandƒ± (${s}):`, event.code, event.reason);
                    st(s, 'Kesildi', 'disconnected');
                    
                    // 5 saniye sonra yeniden baƒülanmayƒ± dene
                    if (c[s] && event.code !== 1000) { // 1000 = normal closure
                        setTimeout(() => {
                            if (c[s]) { // Coin hala listede mi?
                                console.log(`Yeniden baƒülanƒ±yor: ${s}`);
                                cn(s);
                            }
                        }, 5000);
                    }
                };
                
                w.onmessage = e => {
                    try {
                        const d = JSON.parse(e.data);
                        const pe = $(`p${s}`);
                        const he = $(`h${s}`);
                        const ie = $(`i${s}`);
                        const oe = $(`o${s}`);
                        const ve = $(`v${s}`);
                        
                        if (pe) pe.textContent = fp(d.c);
                        if (he) {
                            const ch = +d.P;
                            he.textContent = `${ch >= 0 ? '+' : ''}${ch.toFixed(2)}%`;
                            he.className = `numeric-cell ${ch >= 0 ? 'change-positive' : 'change-negative'}`;
                        }
                        if (ie) ie.textContent = fp(d.h);
                        if (oe) oe.textContent = fp(d.l);
                        if (ve) ve.textContent = fn(d.v);
                        
                        c[s].l = +d.c;
                    } catch (err) {
                        console.error(`Veri parse hatasƒ± (${s}):`, err);
                    }
                };
                
            } catch (error) {
                console.error(`WebSocket olu≈üturma hatasƒ± (${s}):`, error);
                st(s, 'Hata', 'disconnected');
            }
        };
        
        function loadChart(s) {
            console.log(`üìà Grafik y√ºkleniyor: ${s}`);
            const w = document.getElementById('tradingview-widget');
            
            if (!w) {
                console.error('‚ùå TradingView widget container bulunamadƒ±!');
                return;
            }
            
            // Loading mesajƒ± g√∂ster
            w.innerHTML = `<div style="text-align:center;padding:50px 0;opacity:0.7;font-size:16px;">üìà ${s} grafiƒüi y√ºkleniyor...</div>`;
            
            // Eski script'leri temizle
            const oldScripts = document.querySelectorAll('script[src*="tradingview"]');
            oldScripts.forEach(script => script.remove());
            
            setTimeout(() => {
                try {
                    // Yeni widget HTML'i
                    const widgetHTML = `
                        <div class="tradingview-widget-container" style="height:100%;width:100%;">
                            <div class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%;"></div>
                            <div class="tradingview-widget-copyright">
                                <a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank">
                                    <span class="blue-text">Track all markets on TradingView</span>
                                </a>
                            </div>
                        </div>
                    `;
                    
                    w.innerHTML = widgetHTML;
                    
                    // Script elementi olu≈ütur
                    const script = document.createElement('script');
                    script.type = 'text/javascript';
                    script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
                    script.async = true;
                    
                    // Widget konfig√ºrasyonu
                    const config = {
                        "autosize": true,
                        "symbol": `BINANCE:${s}`,
                        "interval": "15",
                        "timezone": "Etc/UTC",
                        "theme": "dark",
                        "style": "1",
                        "locale": "tr",
                        "enable_publishing": false,
                        "withdateranges": true,
                        "range": "1D",
                        "hide_side_toolbar": false,
                        "allow_symbol_change": false,
                        "save_image": false,
                        "calendar": false,
                        "support_host": "https://www.tradingview.com"
                    };
                    
                    script.innerHTML = JSON.stringify(config);
                    
                    // Script'i widget container'a ekle
                    const widgetContainer = w.querySelector('.tradingview-widget-container__widget');
                    if (widgetContainer) {
                        widgetContainer.appendChild(script);
                        console.log(`‚úÖ ${s} grafiƒüi ba≈üarƒ±yla y√ºklendi`);
                    } else {
                        console.error('‚ùå Widget container bulunamadƒ±');
                    }
                    
                } catch (error) {
                    console.error('‚ùå TradingView widget y√ºkleme hatasƒ±:', error);
                    w.innerHTML = `<div style="text-align:center;padding:50px 0;opacity:0.7;color:#ff4757;">
                        ‚ùå Grafik y√ºklenirken hata olu≈ütu<br>
                        <small>${s}</small>
                    </div>`;
                }
            }, 300);
        }
        
        // Global fonksiyon olarak tanƒ±mla
        window.loadChart = loadChart;
        
        // Debug i√ßin test fonksiyonu
        window.testChart = function(symbol) {
            console.log('üß™ Test chart loading:', symbol || 'BTCUSDT');
            loadChart(symbol || 'BTCUSDT');
        };
        
        function addCoin() {
            const inp = $('inp');
            if (!inp) {
                alert('Input kutusu bulunamadƒ±!');
                return;
            }
            let symbol = inp.value.trim().toUpperCase();
            console.log('Girilen coin:', symbol);
            if (!symbol) return alert('L√ºtfen bir coin adƒ± girin!');
            if (!symbol.endsWith('USDT')) symbol += 'USDT';
            console.log('Son coin adƒ±:', symbol);
            if (c[symbol]) return alert(`${symbol} zaten takip ediliyor!`);
            if (Object.keys(c).length >= 20) return alert('Maksimum 20 coin takip edebilirsiniz!');
            
            try {
                c[symbol] = {w: null, l: 0};
                console.log('Coin objesi olu≈üturuldu:', c[symbol]);
                up();
                cn(symbol);
                sv();
                inp.value = '';
                if (Object.keys(c).length === 1) loadChart(symbol);
                console.log('Coin ba≈üarƒ±yla eklendi!');
            } catch (error) {
                console.error('Coin ekleme hatasƒ±:', error);
                alert('Coin eklenirken hata olu≈ütu!');
            }
        }
        
        function removeCoin(s) {
            if (c[s]) {
                c[s].w?.close();
                delete c[s];
                $(`r${s}`).remove();
                sv();
                if (!Object.keys(c).length) up();
            }
        }
        
        function sortBy(col) {
            const tb = $('tb');
            if (!tb) return;
            
            s.dir = s.col === col ? (s.dir === 'asc' ? 'desc' : 'asc') : 'asc';
            s.col = col;
            
            document.querySelectorAll('.sortable').forEach(th => th.classList.remove('asc', 'desc'));
            document.querySelectorAll('.sortable').forEach(th => {
                if (th.getAttribute('onclick')?.includes(`'${col}'`)) th.classList.add(s.dir);
            });
            
            const rs = Array.from(tb.children);
            const ci = {price: 2, change: 3, funding: 4, high: 5, low: 6, vol: 7}[col];
            
            rs.sort((a, b) => {
                if (col === 'coin') {
                    const r = a.cells[0].textContent.trim().localeCompare(b.cells[0].textContent.trim());
                    return s.dir === 'asc' ? r : -r;
                }
                let vA = +(a.cells[ci].textContent.replace(/[\$,+%]/g, '') || 0);
                let vB = +(b.cells[ci].textContent.replace(/[\$,+%]/g, '') || 0);
                if (col === 'vol') {
                    const tA = a.cells[ci].textContent;
                    const tB = b.cells[ci].textContent;
                    if (tA.includes('M')) vA *= 1e6;
                    else if (tA.includes('K')) vA *= 1000;
                    if (tB.includes('M')) vB *= 1e6;
                    else if (tB.includes('K')) vB *= 1000;
                }
                return s.dir === 'asc' ? vA - vB : vB - vA;
            });
            
            tb.innerHTML = '';
            rs.forEach(row => tb.appendChild(row));
        }
        
        // KESIN √á√ñZ√úM: Input Focus ve Event Management
        let inputInitialized = false;
        
        function forceInitializeInput() {
            const inp = document.getElementById('inp');
            
            if (!inp) {
                console.error('‚ùå Input elementi DOM\'da yok!');
                return false;
            }
            
            if (inputInitialized) {
                console.log('‚úÖ Input zaten initialize edildi');
                return true;
            }
            
            try {
                // Test input eri≈üimi
                inp.value = '';
                inp.disabled = false;
                inp.readOnly = false;
                
                // Style kontrol√º 
                inp.style.pointerEvents = 'auto';
                inp.style.display = 'block';
                inp.style.visibility = 'visible';
                
                // Event listeners ekle
                inp.addEventListener('keydown', function(e) {
                    console.log('üîΩ Keydown:', e.key);
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        e.stopPropagation();
                        addCoin();
                    }
                }, true);
                
                inp.addEventListener('keypress', function(e) {
                    console.log('‚å®Ô∏è Keypress:', e.key);
                }, true);
                
                inp.addEventListener('input', function(e) {
                    console.log('üìù Input change:', e.target.value);
                }, true);
                
                inp.addEventListener('focus', function() {
                    console.log('üéØ Input focused');
                }, true);
                
                inp.addEventListener('blur', function() {
                    console.log('üëÄ Input blurred');
                }, true);
                
                // Focus ver
                setTimeout(() => {
                    inp.focus();
                    inp.click();
                    console.log('‚úÖ Input focus verildi');
                }, 100);
                
                inputInitialized = true;
                console.log('‚úÖ Input ba≈üarƒ±yla initialize edildi');
                return true;
                
            } catch (error) {
                console.error('‚ùå Input initialize hatasƒ±:', error);
                return false;
            }
        }
        
        // Multiple initialization strategies
        function initializeApp() {
            console.log('üöÄ App initialization ba≈üladƒ±');
            
            // Input initialize et
            if (!forceInitializeInput()) {
                console.log('‚è≥ Input bulunamadƒ±, 500ms sonra tekrar denenecek');
                setTimeout(() => {
                    if (!forceInitializeInput()) {
                        console.log('‚è≥ 2. deneme, 1000ms sonra tekrar denenecek');
                        setTimeout(() => {
                            forceInitializeInput();
                        }, 1000);
                    }
                }, 500);
            }
            
            // Saved coins y√ºkle
            if (ld()) {
                up();
                Object.keys(c).forEach(cn);
            }
        }
        
        // Multiple DOM ready strategies
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
        
        // Fallback
        window.addEventListener('load', function() {
            if (!inputInitialized) {
                console.log('üîÑ Window load fallback');
                initializeApp();
            }
        });
        
        // Manual trigger for debugging
        window.debugInput = forceInitializeInput;
        
        window.onbeforeunload = () => {
            Object.values(c).forEach(coin => coin.w?.close());
        };
    </script>
</body>
</html>
